# FlairEmotionAnalyzer

## 脳波と心拍変動指標から人間の感情を分析するための諸機能を統合したwebアプリケーション

### はじめに
- 脳波・心拍変動を用いた感情分析に向けたアプリケーションです
- このアプリケーションの実用には，脳波・心拍を計測のための刺激呈示実験の実施が必要です
  - '刺激'の例：画像，映像，匂い，精神負荷タスクなど
  - 下記の「1. データ入力」セクションに示す，入力データに関する条件を満たすデータの用意が可能であれば，実験の必要はありません
- アプリケーション起動にはpython，および対応するライブラリが必要です
  - 実行確認済：python3.9, python3.10, python3.11
  - 必要なライブラリ
    - Dash, dcc, html, Input, Output, State (from dash)
    - plotly
    - math
    - base64
    - pandas
    - io
    - configparser
  - input_sampleフォルダに，アプリケーションの試用のためのサンプルデータが置いてあります
    - sample_dummy_data.csv：脳波と心拍変動指標の尤もらしいダミーデータ
    - config.ini：アプリケーションに必要な設定事項をダミーデータに合わせて定義したもの
- 以下の説明では，被験者のことを'実験協力者'と表記します
### 分析できること
- 脳波・心拍変動指標の時系列的な変動
- 刺激呈示中の実験協力者の感情状態('Happy','Tense','Sad','Relax')の時系列的遷移
- 刺激に対して実験協力者に喚起された総合的な感情('Happy','Tense','Sad','Relax')
### アプリケーション起動方法
- src/main.pyをpythonで実行
### アプリケーション使用手順
#### 1. データアップロード
##### 入力するデータは2つ
- configファイル(拡張子：.ini)
  - configに含まれるセクションは以下：
    - [STIMULATION]：脳波・心拍の計測実験で使用した各刺激に対してユーザが割り当てた番号のリストを指定
    - [REST]：各刺激の前に取った安静に対してユーザが割り当てた番号を指定
    - [PERIOD]：感情ラベル(後述)を算出する時間幅(単位：秒)を指定
- 脳波・心拍変動指標の計測データ(拡張子：.csv)
  - データに含まれている必要があるのは以下：
    - timestamp
    - 脳波の各周波数帯の1秒ごとの時系列データ
      - δ帯，θ帯，α帯(low, high)，β帯(low, high)，ɤ帯(low, mid)
    - 各心拍変動指標の1秒ごとの時系列データ
      - IBI, BPM, CVNN, SDNN, RMSSD, SDNN_over_RMSSD, pNN10, pNN20, pNN30, pNN40, pNN50, LF, HF, LF_over_HF
    - 'stimu_num'
      - 脳波・心拍の計測実験においてユーザが各刺激前安静・各刺激に割り当てた番号を，実験で使用した刺激の順番に記録したもの
      - どの時間帯でどの刺激を実験協力者に与えたのかを特定する
- リポジトリにあるサンプルデータ(input_sample/)は，実験で実験協力者に刺激を3つ呈示したと想定している
- これらのデータを下図の点線内にそれぞれドラッグ＆ドロップ or 手動選択
![スクリーンショット 2024-07-09 200255](https://github.com/FujiGitTatsuya/FlairEmotionAnalyzer/assets/166372180/ac163187-dc76-4abb-88fe-72e31a17b156)
#### 2. データ入力後，画面下に出現する'Go to Plot Page'ボタンを押下
#### 3. 出力されるグラフの解析
##### 出力されるグラフは以下の3つ
- 時系列グラフ＆感情ラベル
![newplot](https://github.com/FujiGitTatsuya/FlairEmotionAnalyzer/assets/166372180/fb880d3f-30f5-4411-ac34-1fe96c243edb)
  - 青線が脳波指標の時系列グラフ，赤線が心拍変動指標の時系列グラフ
  - 緑の棒グラフは刺激呈示，または刺激前安静が開始するタイミングを表している
  - 各刺激呈示区間には"'刺激' + 'stimu_num'"のラベルを表示
  - 各刺激呈示区間では，入力されたconfigファイルで指定された時間幅で算出された感情ラベルを背景に表示
    - 刺激呈示中，実験協力者の感情状態がどのように変化したのかを任意の周期で観察するのが目的
    - 感情は感情マップ(後述)に基づき，'Happy','Tense','Sad','Relax'の4つに分類
    - 'Happy'は黄色,'Tense'は赤色,'Sad'は青色,'Relax'は緑色のラベルで表現
    - サンプルのconfigファイル(input_sample/config.ini)では，感情ラベルの算出周期を'10秒'に指定
- 脳波指標の時系列データに対するノイズ処理の様子
![newplot(1)](https://github.com/FujiGitTatsuya/FlairEmotionAnalyzer/assets/166372180/5a0baf7b-ee72-4ee4-838a-487349a3aa64)
  - 青線が脳波指標の時系列グラフ，橙色の点はノイズ判定された箇所
  - ノイズは中央絶対偏差に基づき判定(src/eeg_noise_median.py)
- 感情マップ
![newplot(2)](https://github.com/FujiGitTatsuya/FlairEmotionAnalyzer/assets/166372180/1fca2f3a-7e4d-47d3-8f9d-6b40e4d9cf90)
  - 脳波と心拍変動指標に基づき，各刺激に対する実験協力者の感情を4つに分類
    - 分類する際，各刺激の呈示中，呈示前安静中の脳波指標，および心拍変動指標の代表値を用いる
  - 縦軸が脳波指標(値が大きいほど覚醒度が高い，小さいほど覚醒度が低い)，横軸が心拍変動指標(値が大きいほど快適，小さいほど不快)
    - 'ラッセルの円環モデル'(心理学分野で著名な感情分類手法)に基づく考え方
  - 第1象限が'Happy'(黄色)，第2象限が'Tense'(赤色)，第3象限が'Sad'(青色)，第4象限が'Relax'(緑色)の感情に対応
  - マップ上にプロットされる点は各刺激を表している
  - 感情マップでは，呈示された刺激に対して喚起された実験協力者の感情を総合的に評価している
    - 刺激中の感情変化を見たい場合は，上記の時系列グラフ上に表示した感情ラベルを分析する
##### ページ上部のドロップダウンの機能
![スクリーンショット 2024-07-09 201042](https://github.com/FujiGitTatsuya/FlairEmotionAnalyzer/assets/166372180/b17e25af-2063-4600-8fcf-bdc8f3e1c732)
- EEG index Stock
  - 分析したい脳波指標を変更可能
  - デフォルトは'lowβ/lowα'
- HRV Stock
  - 分析したい心拍変動指標を変更可能
  - デフォルトは'RMSSD'
- Stimulation Stock
  - 時系列グラフにおいて注目する刺激を変更
  - 変更すると，時系列グラフのx軸の'0'が選択した刺激の呈示が開始した時点になるようにプロットが変更される
##### 感情マップ下のドロップダウンの機能
![スクリーンショット 2024-07-09 201112](https://github.com/FujiGitTatsuya/FlairEmotionAnalyzer/assets/166372180/8a5f3bed-0b58-49e6-8dce-e1e6952e9188)
- 感情分類に用いる各刺激の呈示中，呈示前安静中の脳波指標，および心拍変動指標の代表値(平均値 or 中央値)を変更可能
- デフォルトは平均値
#### 4. ページ最下部の'Go to Upload Page'をクリック
#### 5. データアップロード画面に戻る
#### 6. 別のデータを用いて手順1からリスタート